VARS=-var-file=terraform.tfvars
TF_PLAN=./terraform.plan

terraform.tfvars: ../config.mk
	@if [ -z "$(AWS_PROFILE)" ]; then echo 'need $$AWS_PROFILE set - run from root' && exit 1; fi
	@if [ -z "$(AWS_REGION)" ]; then echo 'need $$AWS_REGION set - run from root' && exit 1; fi
	@if [ -z "$(SHIP)" ]; then echo 'need $$SHIP set - run from root' && exit 1; fi
	@if [ -z "$(DOMAIN)" ]; then echo 'need $$DOMAIN set - run from root' && exit 1; fi
	@if [ -z "$(SSH_KEY_NAME)" ]; then echo 'need $$SSH_KEY_NAME set - run from root' && exit 1; fi
	@rm -rf $@
	@echo '# do not edit. this file was auto-generated by make' >> $@
	@echo 'aws_profile = "$(AWS_PROFILE)"' >> $@
	@echo 'aws_region = "$(AWS_REGION)"' >> $@
	@echo 'ship = "$(SHIP)"' >> $@
	@echo 'domain = "$(DOMAIN)"' >> $@
	@echo 'key_name = "$(SSH_KEY_NAME)"' >> $@

init: terraform.tfvars
	terraform init -backend-config="./backend.config" -reconfigure

plan: init
	terraform plan $(VARS) -out=$(TF_PLAN)

apply:
	terraform apply -auto-approve $(TF_PLAN)

plan-destroy:
	terraform plan -destroy $(VARS) -out=$(TF_PLAN)

destroy:
	terraform destroy $(VARS)

.PHONY: init plan apply plan-destroy destroy
