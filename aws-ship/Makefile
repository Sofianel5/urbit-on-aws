VARS=-var-file=terraform.tfvars
TF_PLAN=./terraform.plan

terraform.tfvars:
	@if [ -z "$(AWS_PROFILE)" ]; then echo 'need $$AWS_PROFILE set' && exit 1; fi
	@if [ -z "$(AWS_REGION)" ]; then echo 'need $$AWS_REGION set' && exit 1; fi
	@if [ -z "$(SHIP)" ]; then echo 'need $$SHIP set' && exit 1; fi
	@if [ -z "$(DOMAIN)" ]; then echo 'need $$DOMAIN set' && exit 1; fi
	@if [ -z "$(SSH_KEY_NAME)" ]; then echo 'need $$SSH_KEY_NAME set' && exit 1; fi
	@rm -rf $@
	@echo '# do not edit. this file was auto-generated by make' >> $@
	@echo 'aws_profile = "$(AWS_PROFILE)"' >> $@
	@echo 'aws_region = "$(AWS_REGION)"' >> $@
	@echo 'ship = "$(SHIP)"' >> $@
	@echo 'domain = "$(DOMAIN)"' >> $@
	@echo 'key_name = "$(SSH_KEY_NAME)"' >> $@

init:
	terraform init

plan:
	terraform plan $(VARS) -out=$(TF_PLAN)

apply:
	terraform apply -auto-approve

plan-destroy:
	terraform plan -destroy $(VARS) -out=$(TF_PLAN)

destroy:
	terraform destroy $(VARS)

