VARS=-var-file=terraform.tfvars
TF_PLAN=./terraform.plan

terraform.tfvars:
	@if [ -z "$(AWS_PROFILE)" ]; then echo 'need $$AWS_PROFILE set' && exit 1; fi
	@if [ -z "$(AWS_REGION)" ]; then echo 'need $$AWS_REGION set' && exit 1; fi
	@rm -rf $@
	@echo '# do not edit. this file was auto-generated by make' >> $@
	@echo 'aws_profile = "$(AWS_PROFILE)"' >> $@
	@echo 'aws_region = "$(AWS_REGION)"' >> $@
	@echo 'output_config_path = "../aws-ship/backend.config"' >> $@

init:
	terraform init

plan:
	terraform plan $(VARS) -out=$(TF_PLAN)

apply:
	terraform apply -auto-approve $(TF_PLAN)

plan-destroy:
	terraform plan -destroy $(VARS) -out=$(TF_PLAN)

destroy:
	terraform destroy $(VARS)

